var dcaWizard=new Class({Implements:[Options],Binds:["sendOperation","addURLFragment"],options:{baseURL:"",referer:"",scroll:false},initialize:function(b,a){this.element=document.id(b);this.element.dcawizard=this;this.setOptions(a);document.getElements(".tl_formbody_submit .tl_submit").each(function(c){c.set("_accesskey",c.get("accesskey"))});document.getElements("form.tl_form").each(function(c){if(c.getParent(".tl_version_panel")){return}c.addEvent("submit",function(){c.removeEvents();new Request({method:"get",url:(this.addURLFragment(this.options.referer)),onComplete:function(){c.submit()}}).send();return false}.bind(this));c.getElements("input.tl_submit").each(function(d){d.addEvent("click",function(){new Element("input",{type:"hidden",name:d.get("name"),value:d.get("value")}).inject(c)})})}.bind(this));this.request=new Request.DCAWizard({link:"abort",evalScripts:false,onRequest:function(){AjaxRequest.displayBox("Loading data â€¦")},onComplete:function(){AjaxRequest.hideBox();if(this.options.scroll){new Fx.Scroll(window).toElement(this.element)}},onCancel:function(){AjaxRequest.hideBox()},onFailure:function(c){alert("failed")},onSuccess:function(e,c,f,d){if(e.length<2&&f.test(/^http|\/main.php/)){this.request.send({url:f,method:"get"});return}$A(e).each(function(g){if($(g)&&$(g).get&&g.get("id")=="container"){document.getElements(".tl_formbody_submit .tl_submit").each(function(i){if(g.getElement(".tl_formbody_submit")){i.set("disabled",true).set("accesskey","")}else{i.set("disabled",false).set("accesskey",i.get("_accesskey"))}});if(g.getElement(".tl_panel")){g.getElement(".tl_panel").getParent("form").destroy()}this.element.empty().adopt(g.getElement("div[id=main]").getChildren());this.element.getElements(".tl_content_right a, .tl_right_nowrap a").each(function(i){i.dcaclick=i.onclick;i.set("onclick","");i.addEvent("click",this.sendOperation)}.bind(this));this.element.getElements("form.tl_form").each(function(i){i.submit=function(){return this.fireEvent("submit")};i.addEvent("submit",function(){try{if($defined(tinyMCE)){i.getElements("textarea").each(function(k){tinyMCE.execCommand("mceRemoveEditor",false,k.get("id"))})}}catch(j){}this.request.send({url:(this.addURLFragment(i.action)),data:this.addURLFragment(i.toQueryString(),true),method:"post"});return false}.bind(this));i.getElements("input.tl_submit").each(function(j){j.addEvent("click",function(){new Element("input",{type:"hidden",name:j.get("name"),value:j.get("value")}).inject(i)})}.bind(this))}.bind(this));this.adoptButtons();$exec(d.replace(/.*<!--.*|.*-->.*/g,""));try{if($defined(tinyMCE)){tinyMCE.dom.Event._pageInit(window)}}catch(h){}Backend.addInteractiveHelp();Backend.hideTreeBody()}}.bind(this))}.bind(this)});this.request.send({url:(this.addURLFragment(this.options.baseURL)),method:"get"})},sendOperation:function(a){button=a.target;if(button.getParent().get("tag")=="a"){button=button.getParent()}if(button.dcaclick&&button.dcaclick.toString().contains("AjaxRequest.toggleVisibility")){return this.toggleVisibility(button)}if(button.dcaclick&&button.dcaclick()==false){return false}new Request({method:"get",url:(this.addURLFragment(this.options.baseURL)),onSuccess:function(){this.request.send({url:this.addURLFragment(button.get("href")),method:"get"})}.bind(this)}).send();return false},adoptButtons:function(){if(this.element.getElement("div[id=tl_buttons]")){var a=this.element.getPrevious().getElement(".tl_content_right");if(!a){a=new Element("div",{"class":"tl_content_right"}).inject(this.element.getPrevious(),"top")}a.empty();var b=$defined(this.element.getElement(".tl_listing_container"));this.element.getElement("div[id=tl_buttons]").getElements("a").each(function(c){if(b&&c.hasClass("header_back")){return}if(c.hasClass("header_new")||c.hasClass("header_back")||c.hasClass("header_clipboard")){c.dcaclick=c.onclick;c.onclick="";c.addEvent("click",this.sendOperation)}a.grab(c)}.bind(this));if(this.element.getElement(".tl_header .tl_content_right")){this.element.getElements(".tl_header .tl_content_right a").each(function(c){if(c.href.test(/act=edit/)){return}c.dcaclick=c.onclick;c.onclick="";c.addEvent("click",this.sendOperation);new Element("span",{text:c.getElement("img").get("alt"),styles:{"padding-left":"5px"}}).inject(c);a.grab(c)}.bind(this))}}},addURLFragment:function(a,b){if(b&&!a.contains("&action=dcaWizard")){a+="&action=dcaWizard"}else{if(!a.contains("&dcaWizard=1")){a+="&dcaWizard=1"}}return a},toggleVisibility:function(d){var b=new URI(d.get("href"));var c=b.getData("id");var i=b.getData("table");d.blur();var g=null;var f=$(d).getFirst("img");var e=(f.src.indexOf("invisible")!=-1);var a=d.getParent("div");if(a.hasClass("tl_right")){g=a.getPrevious("div").getElement("img")}else{if(a.hasClass("tl_listing_container")){g=d.getParent("td").getPrevious("td").getFirst("div.list_icon");if(g==null){g=d.getParent("td").getPrevious("td").getElement("div.cte_type")}if(g==null){g=d.getParent("tr").getFirst("td").getElement("div.list_icon_new")}}else{if((next=a.getNext("div"))&&next.hasClass("cte_type")){g=next}}}if(g!=null){if(g.nodeName.toLowerCase()=="img"){if(g.getParent("ul.tl_listing").hasClass("tl_tree_xtnd")){if(e){g.src=g.src.replace(/_\.(gif|png|jpe?g)/,".$1")}else{g.src=g.src.replace(/\.(gif|png|jpe?g)/,"_.$1")}}else{if(g.src.match(/folPlus|folMinus/)){if(g.getParent("a").getNext("a")){g=g.getParent("a").getNext("a").getFirst("img")}else{g=new Element("img")}}if(e){var h=g.src.replace(/.*_([0-9])\.(gif|png|jpe?g)/,"$1");g.src=g.src.replace(/_[0-9]\.(gif|png|jpe?g)/,((h.toInt()==1)?"":"_"+(h.toInt()-1))+".$1")}else{var h=g.src.replace(/.*_([0-9])\.(gif|png|jpe?g)/,"$1");g.src=g.src.replace(/(_[0-9])?\.(gif|png|jpe?g)/,((h==g.src)?"_1":"_"+(h.toInt()+1))+".$2")}}}else{if(g.hasClass("cte_type")){if(e){g.addClass("published");g.removeClass("unpublished")}else{g.addClass("unpublished");g.removeClass("published")}}else{if(e){g.setStyle("background-image",g.getStyle("background-image").replace(/_\.(gif|png|jpe?g)/,".$1"))}else{g.setStyle("background-image",g.getStyle("background-image").replace(/\.(gif|png|jpe?g)/,"_.$1"))}}}}if(i=="tl_style"){a.getParent("div").getElement("pre").toggleClass("disabled")}if(e){f.src=f.src.replace("invisible.gif","visible.gif");new Request({url:b}).get({state:1})}else{f.src=f.src.replace("visible.gif","invisible.gif");new Request({url:b}).get({state:0})}return false}});var Group=new Class({initialize:function(){this.instances=Array.flatten(arguments);this.events={};this.checker={}},addEvent:function(b,a){this.checker[b]=this.checker[b]||{};this.events[b]=this.events[b]||[];if(this.events[b].contains(a)){return false}else{this.events[b].push(a)}this.instances.each(function(c,d){c.addEvent(b,this.check.bind(this,[b,c,d]))},this);return this},check:function(c,a,b){if(b==null&&a==null){a=c[1];b=c[2];c=c[0]}this.checker[c][b]=true;var d=this.instances.every(function(f,e){return this.checker[c][e]||false},this);if(!d){return}this.checker[c]={};this.events[c].each(function(e){e.call(this,this.instances,a)},this)}});Request.DCAWizard=Class.refactor(Request.HTML,{options:{evalExternalScripts:true,evalExternalStyles:true},success:function(i){var j;try{j=JSON.decode(i);if(j.target){this.cancel();this.send({url:j.target});return}if(j.token){REQUEST_TOKEN=j.token}i=j.content}catch(d){}var f=/var REQUEST_TOKEN = '([^']+)';/gi;while(b=f.exec(i)){REQUEST_TOKEN=b[1]}$$('input[type="hidden"]').each(function(h){if(h.name=="REQUEST_TOKEN"){h.value=REQUEST_TOKEN}});if(this.options.evalExternalStyles){var f=/<link.*href=('|")([^>'"\r\n]*)('|")[^>]*>/gi;var b=stylesheets=[];while(b=f.exec(i)){if(!/fixes.css/.exec(b[2])&&!document.getElement(("link[href="+b[2]+"]"))){Asset.css(b[2])}}}if(this.options.evalExternalScripts){var f=/<script.*src=('|")([^>'"\r\n]*)('|")[^>]*><\/script>/gi;var b=scripts=[];while(b=f.exec(i)){if(!document.getElement(("script[src="+b[2]+"]"))){scripts.push(b[2])}}if(scripts.length>0){var c=document.getElementsByTagName("head")[0];var a=[];scripts.each(function(h){a.push(new Element("script",{type:"text/javascript",src:h}));$(c).grab(a[a.length-1])});var e=this.previous;var g=new Group(a);g.addEvent("load",function(){e.apply(this,[i])}.bind(this)).addEvent("readystatechange",function(){e.apply(this,[i])}.bind(this))}else{this.previous(i)}}else{this.previous(i)}}});Backend.previousMakeParentViewSortable=Backend.makeParentViewSortable;Backend.makeParentViewSortable=function(a){a=$(a);if(a.getParent(".dcawizard")){var b=new Sortables(a,{contstrain:true,opacity:0.6});b.active=false;b.addEvent("start",function(){b.active=true});b.addEvent("complete",function(d){if(!b.active){return}if(d.getPrevious()){var f=d.get("id").replace(/li_/,"");var c=d.getPrevious().get("id").replace(/li_/,"");var e=new URI(a.getParent(".dcawizard").dcawizard.options.baseURL).get("query").replace(/id=[0-9]*/,"id="+f)+"&act=cut&mode=1&pid="+c;new Request({url:a.getParent(".dcawizard").dcawizard.options.baseURL,method:"get",data:e}).send()}else{if(d.getParent()){var f=d.get("id").replace(/li_/,"");var c=d.getParent().get("id").replace(/ul_/,"");var e=new URI(a.getParent(".dcawizard").dcawizard.options.baseURL).get("query").replace(/id=[0-9]*/,"id="+f)+"&act=cut&mode=2&pid="+c;new Request({url:a.getParent(".dcawizard").dcawizard.options.baseURL,method:"get",data:e}).send()}}})}else{Backend.previousMakeParentViewSortable(a)}};